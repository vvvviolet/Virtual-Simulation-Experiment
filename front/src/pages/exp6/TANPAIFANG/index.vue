<template>
    <div class="main">
        <!-- è¿›å…¥å®éªŒç•Œé¢ -->
        <section v-if="sectionIndex==0">

        </section>

        <!-- æŠ¥ä»·ç•Œé¢ -->
        <section v-if="sectionIndex==1">
            <div class="header-wrapper">
                <p class="title ml-2">äºŒã€å®éªŒå†…å®¹-åœºæ™¯æ¨¡æ‹Ÿ</p>
            </div>

            <p class="secondtitle">ç¬¬ä¸€æ­¥ï¼šå®éªŒèƒŒæ™¯è¯´æ˜</p>
            <p class="content">
                ç¢³æ’æ”¾äº¤æ˜“æ˜¯ä¸€ç§æ”¿åºœæˆ–å›½é™…æœºæ„é‡‡ç”¨çš„ä¸€é¡¹æ”¿ç­–å·¥å…·ï¼Œæ—¨åœ¨å‡å°‘æ¸©å®¤æ°”ä½“ï¼ˆç‰¹åˆ«æ˜¯äºŒæ°§åŒ–ç¢³ï¼‰çš„æ’æ”¾é‡ï¼Œä»¥åº”å¯¹æ°”å€™å˜åŒ–é—®é¢˜ã€‚å®ƒåŸºäºç¢³æ’æ”¾çš„ç»æµåŸç†ï¼Œé€šè¿‡è®¾ç«‹ä¸€ä¸ªç¢³å¸‚åœºæ¥çº¦æŸå’Œè§„èŒƒä¼ä¸šã€ç»„ç»‡æˆ–å›½å®¶çš„ç¢³æ’æ”¾è¡Œä¸ºã€‚
                <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                æœ¬å®éªŒä¸­ï¼Œæ•™å¸ˆå°†è®²è§£å¸‚åœºä¸Šæ­£å¸¸çš„ç¢³æ’æ”¾å¸‚åœºäº¤æ˜“çš„æƒ…å†µã€‚æ³¨ï¼šä¸€ä¸ªå•ä½ç¢³æ’æ”¾æƒçš„å®šä»·åªæ˜¯ä¸€ä¸ªåä¹‰ä»·æ ¼ï¼Œå¹¶éçœŸå®çš„å¸‚åœºäº¤æ˜“ä»·æ ¼ã€‚
            </p>

            <p class="secondtitle">ç¬¬äºŒæ­¥ï¼šå®éªŒåœºæ™¯è¯´æ˜</p>
            <p class="content">
                äº†è§£ç»´å…‹é‡Œæ‹å–æ³•åŸç†ï¼Œå‚ä¸æœ¬å®éªŒçš„å­¦ç”Ÿå…ˆåå°†æ‰®æ¼”ä¸¤ç§è§’è‰²(å³å¸‚åœºä¾›ç»™
                è€…å’Œéœ€æ±‚è€…)ï¼Œå¯ä»¥æŒ‰ç…§æœ¬äººå¯¹äºæ­¤ä¸€ä¸ªå•ä½çš„ç¢³æ’æ”¾æƒçš„çœŸå®éœ€æ±‚æŠ¥ä»·ã€‚å‚ä¸å®éªŒå­¦ç”Ÿä¸å¾—ä¸²é€šæŠ¥ä»·ä¿¡æ¯ï¼Œå¦åˆ™å°†å½±å“æ­£å¸¸çš„ä¾›éœ€ä»·æ ¼å…³ç³»çš„å¹³è¡¡ã€‚
                <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                <strong>
                    ç¬¬ä¸€æ¬¡å¡«å†™çš„æŠ¥ä»·æ˜¯ä½œä¸ºä¾›ç»™è€…ï¼Œæ ¹æ®ä½ å¿ƒç›®ä¸­çš„ç¢³æ’æ”¾æƒçš„æœ€ä½å•ä½ä»·æ ¼æ¥è¿›è¡ŒæŠ¥ä»·å‡ºå”®ï¼Œè‹¥å¸‚åœºå®šä»·é«˜äºä½ çš„æŠ¥ä»·ï¼Œå°†è‡ªåŠ¨è§†ä¸ºä½ æ„¿æ„å‡ºå”®ï¼›
                    <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    ç¬¬äºŒæ¬¡å¡«å†™çš„æŠ¥ä»·æ˜¯ä½œä¸ºéœ€æ±‚è€…ï¼Œè¯·æ ¹æ®ä½ å¿ƒç›®ä¸­çš„ç¢³æ’æ”¾æƒçš„æœ€é«˜å•ä½ä»·æ ¼æ¥è¿›è¡ŒæŠ¥ä»·è´­ä¹°ï¼Œè‹¥å¸‚åœºå®šä»·ä½äºäºä½ çš„æŠ¥ä»·ï¼Œå°†è‡ªåŠ¨è§†ä¸ºä½ æ„¿æ„è´­ä¹°ã€‚                
                </strong>
            </p>

            <p class="secondtitle">ç¬¬ä¸‰æ­¥ï¼šæ¨¡æ‹ŸæŠ¥ä»·</p>
            <div style="display: flex;align-items:center">
                <p class="mr-5 mb-0" style="margin-left: 50px; font-size:18px">
                    ä¾›ç»™æ–¹æŠ¥ä»·
                </p>
                <a-input-number size="large"  v-model:value="seller_price" addon-before="æŠ¥ä»·" addon-after="å…ƒ"></a-input-number>

                <p class="mr-5 mb-0" style="margin-left: 50px; font-size:18px">
                    éœ€æ±‚æ–¹æŠ¥ä»·
                </p>
                <a-input-number size="large"  v-model:value="buyer_price" addon-before="æŠ¥ä»·" addon-after="å…ƒ"></a-input-number>

                <a-button style="margin-left: 50px;" type="primary" @click="submitData" shape="round"> <arrow-up-outlined />æäº¤æŠ¥ä»·</a-button>
            </div>
            
            <p class="content mt-5">
                åœ¨çº¿å®éªŒäººæ•°ä¸ºï¼š{{ experimentParticipantCount }}
            </p>
            
        </section>

        <!-- å®éªŒç»“æœç•Œé¢ -->
        <section v-if="sectionIndex==2">
            <div class="header-wrapper">
                <p class="title ml-2">ä¸‰ã€å®éªŒç»“æœ</p>
                <div>
                    <a-button class="mr-2" type="primary" @click="getData" shape="round"> <bar-chart-outlined />è·å–æ•°æ®</a-button>
                    <a-button class="mr-2" type="primary" @click="drawChart" shape="round"> <area-chart-outlined />ç»˜åˆ¶å›¾è¡¨</a-button>
                </div>
            </div>
            <div class="container" >
                <div v-if="visibility.dataInfo==false">
                    <h2>è¿˜æ²¡æœ‰æ•°æ®ï¼Œç‚¹å‡»æŒ‰é’®è·å–æ•°æ®å§ğŸ¤–</h2>
                </div>
                <div class="table-container" v-if="visibility.dataInfo">
                    <div class="table-wrapper">
                        <h2>ä¹°æ–¹å‡ºä»·</h2>
                        <a-table :columns="columns_buyer" :data-source="buyer_info"></a-table>
                    </div>
                    <div class="table-wrapper">
                        <h2>å–æ–¹å‡ºä»·</h2>
                        <a-table :columns="columns_seller" :data-source="seller_info"></a-table>
                    </div>
                </div>
                <!-- ä½¿ç”¨ echarts ç»˜åˆ¶å›¾è¡¨ -->
                <div class="chart-container" v-if="visibility.chart">
                    <div class="chart-wrapper">
                        <div id="chart1" class="chart"></div>
                    </div>
                    <div class="chart-wrapper">
                        <div id="chart2" class="chart"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- å®éªŒæŠ¥å‘Šç•Œé¢ -->
        <section v-if="sectionIndex==3">
            
        </section>
    </div>
    <div class="bottom-wrapper" >
        <a-button style="float: left;" size="large" type="link" @click="PgUp" v-if="sectionIndex>0"><arrow-left-outlined /> ä¸Šä¸€é¡µ</a-button>
        <a-button style="float: right;" size="large" type="link" @click="PgDn" v-if="sectionIndex<3"> ä¸‹ä¸€é¡µ<arrow-right-outlined /></a-button>
    </div>
</template>


<script lang="ts">
import {defineComponent} from "vue";
import * as echarts from "echarts";
import {Space, Table, Tag, message } from "ant-design-vue";
import axios from "axios";

export default defineComponent({
    name: "CarbonEmission",
    components: {
        aTable: Table,
        aTag: Tag,
        aSpace: Space,
    },
    data() {
        return {
            sectionIndex: 2,//å–å€¼ä¸º 0 1 2 3 å…±4é¡µ

            visibility:{
                dataInfo: false,
                chart: false,
            },

            buyer_price: null, //ä¹°æ–¹æŠ¥ä»·
            seller_price: null, //å–æ–¹æŠ¥ä»·

            experimentParticipantCount: null,//åœ¨çº¿å®éªŒäººæ•°
            // 1. ä¹°æ–¹å‡ºä»·ä¿¡æ¯
            // price, count, cum_count, cum_price
            buyer_info: [],
            // 2. å–æ–¹å‡ºä»·ä¿¡æ¯
            // price, count, cum_count
            seller_info: [],
            // 3. columns_buyer
            columns_buyer: [
                {
                    title: "å‡ºä»·",
                    dataIndex: "price",
                    key: "price",
                    slots: {customRender: "price"},
                },
                {
                    title: "æ•°é‡",
                    dataIndex: "count",
                    key: "count",
                    slots: {customRender: "count"},
                },
                {
                    title: "ç´¯è®¡æ•°é‡",
                    dataIndex: "cum_count",
                    key: "cum_count",
                    slots: {customRender: "cum_count"},
                },
                {
                    title: "ç´¯è®¡ä»·æ ¼",
                    dataIndex: "cum_price",
                    key: "cum_price",
                    slots: {customRender: "cum_price"},
                },
            ],
            // 4. columns_seller
            columns_seller: [
                {
                    title: "å‡ºä»·",
                    dataIndex: "price",
                    key: "price",
                    slots: {customRender: "price"},
                },
                {
                    title: "æ•°é‡",
                    dataIndex: "count",
                    key: "count",
                    slots: {customRender: "count"},
                },
                {
                    title: "ç´¯è®¡æ•°é‡",
                    dataIndex: "cum_count",
                    key: "cum_count",
                    slots: {customRender: "cum_count"},
                },
            ],
        }
    },
    methods: {
        PgUp(){
            if(this.sectionIndex >0 ){
                this.sectionIndex=this.sectionIndex-1;
                console.log(this.sectionIndex);              
            }
        },
        PgDn(){
            if(this.sectionIndex <3 ){
                this.sectionIndex=this.sectionIndex+1;
                console.log(this.sectionIndex);
            }
        },

        submitData(){
            axios({
                method: "post",
                url: "http://127.0.0.1:8000/experiments/1/bids",
                data:{
                    student_id: 1,
                    buyer_price: this.buyer_price,
                    seller_price: this.seller_price,
                }
            }).then((res) => {
                
                message.success('æäº¤æˆåŠŸ')
            }).catch((err) => {
                console.log(err);
            })

        },
        // ä½¿ç”¨ echarts ç»˜åˆ¶å›¾è¡¨
        drawChart(){
            this.visibility.chart = true;
            this.$nextTick(()=>{
                // å¦‚æœé¡µé¢ä¸Šå·²ç»å­˜åœ¨å®ä¾‹åŒ–çš„å›¾è¡¨ï¼Œå…ˆé”€æ¯
                echarts.dispose(document.getElementById("chart1"));
                echarts.dispose(document.getElementById("chart2"));

                console.log("drawChart");
                // ç”»å‡ºä¹°å–åŒæ–¹å‡ºä»·åˆ†å¸ƒå›¾, æŠ˜çº¿å›¾
                const chart1 = echarts.init(document.getElementById("chart1"));

                const option1 = {
                    title: {
                        text: "ä¹°å–åŒæ–¹å‡ºä»·åˆ†å¸ƒ",
                        left: "center"
                    },
                    tooltip: {},
                    legend: {
                        data: ["ä¹°å®¶", "å–å®¶"],
                        // æ”¾åœ¨å›¾è¡¨ä¸‹æ–¹
                        bottom: 0
                    },
                    xAxis: {
                        name: "å‡ºä»·",
                        type: "value",
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        name: "ç´¯è®¡æ•°é‡",
                        type: "value",
                        splitLine: {
                            show: false
                        }
                    },
                    series: [
                        {
                            name: "ä¹°å®¶",
                            type: "line",
                            data: this.buyer_info.map((item) => [item.price, item.cum_count])
                        },
                        {
                            name: "å–å®¶",
                            type: "line",
                            data: this.seller_info.map((item) => [item.price, item.cum_count])
                        }
                    ]
                };
                chart1.setOption(option1);

                // ç”»å‡ºä¹°å®¶çš„ç´¯è®¡ä»·æ ¼æ›²çº¿å›¾ï¼Œæ ‡è®°å‡ºæœ€å¤§å€¼
                const chart2 = echarts.init(document.getElementById("chart2"));

                const option2 = {
                    title: {
                        text: "ä¹°å®¶ç´¯è®¡ä»·æ ¼æ›²çº¿",
                        left: "center"
                    },
                    tooltip: {
                        trigger: "axis"
                    },
                    xAxis: {
                        name: "æ•°é‡",
                        type: "value",
                        splitLine: {
                            show: false
                        }
                    },
                    yAxis: {
                        name: "ä»·æ ¼",
                        type: "value",
                        splitLine: {
                            show: false
                        }
                    },
                    series: [
                        {
                            name: "ä¹°å®¶",
                            type: "line",
                            data: this.buyer_info.map((item) => [item.cum_count, item.cum_price]),
                            markPoint: {
                                data: [
                                    {type: 'max', name: 'æœ€å¤§å€¼'},
                                ]
                            }
                        }
                    ]
                };
                chart2.setOption(option2);
                console.log("drawChart end");
            });
        },
        //  è·å–æ•°æ® GET 127.0.0.1:8000/experiments/1/result
        getData(){
            // 1. è·å–æ•°æ®
            axios({
                method: "get",
                url: "http://127.0.0.1:8000/experiments/1/result",
            }).then((res) => {
                // 2. å°†æ•°æ®èµ‹å€¼ç»™ buyer_info å’Œ seller_info
                this.buyer_info = res.data.buy;
                this.seller_info = res.data.sell;
                // console.log(this.buyer_info);
                // console.log(this.seller_info);
               this.visibility.dataInfo=true;
            }).catch((err) => {
                console.log(err);
            })
        },

        //è·å–å®éªŒäººæ•°
        getExperimentParticipantCount(){
            axios({
                method: "get",
                url: "http://127.0.0.1:8000/online-count",
            }).then((res) => {
                this.experimentParticipantCount = res.data.count;
            }).catch((err) => {
                console.log(err);
            })
        },
        startPolling() {
            this.pollingInterval = setInterval(() => {
                this.getExperimentParticipantCount()//è½®è¯¢è·å–å®éªŒäººæ•°
            }, 3000); // Polling interval of 3 seconds (3000 milliseconds)
        },
        stopPolling() {
            clearInterval(this.pollingInterval);
        },
    },
    mounted() {
        // 1. è·å–æ•°æ®
        // this.getData();
        this.startPolling();
    },
    unmounted(){
        this.stopPolling();
    },
})

</script>



<style scoped>
.main{
    min-height: 500px;
    position: relative;
}
section{
    position: relative;
}
.container {
    margin: 0 auto;
    padding: 24px;
}

.header-wrapper {
    display: flex;
    justify-content: space-between;
    margin: 10px;
}

.table-container {
    display: flex;
    justify-content: space-between;
    margin-bottom: 24px;
}

.table-wrapper {
    width: 48%;
}

.chart-container {
    display: flex;
    justify-content: center;
    margin-top: 24px;
}

.chart-wrapper {
    width: 50%;
}
.title {
    text-align: center;
    font-family: sans-serif;
    font-size: 30px;
    margin-bottom: 0px;
}
.secondtitle {
    text-indent: 2em;
    font-weight: bold;
    font-size: 20px;
}
.chart{
    width: 100%;
    height: 500px;
}

.bottom-wrapper{
    margin: 16px;
    left:0;
    width: 97%;
}
.content {
    text-indent: 2em;
    margin-left: 20px;
    margin-right: 20px;
    font-size: 16px;
}

</style>